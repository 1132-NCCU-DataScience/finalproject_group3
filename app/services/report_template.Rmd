---
title: "Starlink 台北地區覆蓋分析報告 (R 版本)"
output:
  html_document:
    toc: true
    toc_float: true
    theme: spacelab
    highlight: tango
    df_print: paged
params:
  # data_dir: "app/static"  # 注解掉原有的預設值
  data_dir: NULL # 設定為 NULL，確保依賴 render 函數傳入的值
  stats_file: "coverage_stats.json"
  coverage_file: "coverage_data.csv"
  sat_timeline_plot: "visible_satellites_timeline.png"
  elev_timeline_plot: "elevation_timeline.png"
  heatmap_plot: "coverage_heatmap.html"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

message(paste("RMD Setup: Initial getwd():", getwd())) # Should be app/services/ when rmarkdown::render runs
message(paste("RMD Setup: Initial params$data_dir (absolute path from R script):", params$data_dir))

# params$data_dir is the absolute path to app/static/
# e.g., /home/lean/Starlink-Taipei/app/static
data_dir_path <- normalizePath(params$data_dir, mustWork = TRUE) # It must exist
message(paste("RMD Setup: Verified absolute data_dir_path:", data_dir_path))

# 載入必要的套件
library(jsonlite)
library(knitr)
library(DT)
library(tidyverse)
library(lubridate)
library(htmltools)

# 原始檔案的絕對路徑
abs_stats_path <- file.path(data_dir_path, params$stats_file)
abs_coverage_path <- file.path(data_dir_path, params$coverage_file)
abs_sat_plot_path <- file.path(data_dir_path, params$sat_timeline_plot)
abs_elev_plot_path <- file.path(data_dir_path, params$elev_timeline_plot)
abs_heatmap_path <- file.path(data_dir_path, params$heatmap_plot)

message(paste("RMD Setup: Absolute sat_plot_path:", abs_sat_plot_path))
message(paste("RMD Setup: Does abs_sat_plot_path exist?", file.exists(abs_sat_plot_path)))

# 創建一個 Rmd 文件旁邊的臨時目錄來存放圖片副本
# getwd() 在 rmarkdown::render 執行此 chunk 時，通常是 Rmd 文件所在的目錄
# (例如 /home/lean/Starlink-Taipei/app/services)
temp_fig_dir_name <- "temp_report_figures"
# 相對路徑 temp_report_figures (相對於 Rmd 文件)
relative_temp_fig_dir <- temp_fig_dir_name 
# 絕對路徑
absolute_temp_fig_dir <- normalizePath(file.path(getwd(), temp_fig_dir_name), mustWork = FALSE)

if (!dir.exists(absolute_temp_fig_dir)) {
  dir.create(absolute_temp_fig_dir, recursive = TRUE)
  message(paste("RMD Setup: Created temp fig dir:", absolute_temp_fig_dir))
}

# 複製文件並返回相對於 Rmd 文件的路徑供 include_graphics 使用
copy_to_local_temp_fig <- function(absolute_original_path, temp_dir_relative_path) {
  if (!file.exists(absolute_original_path)) {
    warning(paste("Original file for copy does not exist:", absolute_original_path))
    return(basename(absolute_original_path)) # Fallback to basename
  }
  # 目標是 Rmd 文件旁邊的子目錄
  dest_file_path_abs <- file.path(normalizePath(temp_dir_relative_path, mustWork=TRUE), basename(absolute_original_path))

  success <- file.copy(absolute_original_path, dest_file_path_abs, overwrite = TRUE)
  if (success) {
    # include_graphics 需要的路徑是相對於 Rmd 文件的
    # 例如 "temp_report_figures/my_image.png"
    local_path_for_include <- file.path(temp_dir_relative_path, basename(absolute_original_path))
    message(paste("RMD Setup: Copied", basename(absolute_original_path), "to local temp. Path for include_graphics:", local_path_for_include))
    return(local_path_for_include)
  } else {
    warning(paste("Failed to copy", basename(absolute_original_path), "to temp dir."))
    # 如果複製失敗，嘗試直接使用絕對路徑 (雖然這之前失敗了)
    return(absolute_original_path)
  }
}

# 使用複製後的相對路徑
sat_plot_path_for_rmd <- copy_to_local_temp_fig(abs_sat_plot_path, relative_temp_fig_dir)
elev_plot_path_for_rmd <- copy_to_local_temp_fig(abs_elev_plot_path, relative_temp_fig_dir)

# HTML 文件通常可以直接使用絕對路徑，或者如果它是自包含的，也可能需要相對路徑
# htmltools::includeHTML 應該能處理絕對路徑，所以 heatmap_path 保持為絕對路徑
heatmap_path_for_rmd <- abs_heatmap_path 
message(paste("RMD Setup: Path for heatmap (includeHTML):", heatmap_path_for_rmd))
message(paste("RMD Setup: Does heatmap_path_for_rmd exist?", file.exists(heatmap_path_for_rmd)))

# 統計和覆蓋數據文件路徑 (這些由 read_json 和 read_csv 讀取，它們應該能處理絕對路徑)
stats_path <- abs_stats_path
coverage_path <- abs_coverage_path

# 檢查檔案是否存在 (用於 json/csv 讀取)
if (!file.exists(stats_path)) {
  stop(paste("統計檔案不存在 (abs path):", stats_path))
}
if (!file.exists(coverage_path)) {
  stop(paste("覆蓋資料檔案不存在 (abs path):", coverage_path))
}

# 讀取統計數據
stats_data <- read_json(stats_path, simplifyVector = TRUE)

# 讀取覆蓋資料 (取樣前 100 筆用於表格顯示)
coverage_data <- read_csv(coverage_path, show_col_types = FALSE) 
```

## 1. 分析概述

本報告詳細說明了 Starlink 衛星在台北地區的覆蓋情況。分析基於最新的 TLE (Two-Line Element) 數據，模擬特定時間段內的可見衛星數量、最大仰角等關鍵指標。

- **觀測地點:** 台北 (`r sprintf("%.2f", stats_data$observer_location$lat)`°N, `r sprintf("%.2f", stats_data$observer_location$lon)`°E)
- **分析時長:** `r stats_data$analysis_duration_minutes` 分鐘
- **數據更新時間:** `r stats_data$last_updated_time`

## 2. 核心統計指標

以下表格總結了本次分析的主要統計結果：

```{r stats_table}
stats_df <- data.frame(
  指標 = c("平均可見衛星數", "最大可見衛星數", "最小可見衛星數", 
           "整體覆蓋率 (%)", "平均最大仰角 (°)", "最高衛星仰角 (°)"),
  數值 = c(
    sprintf("%.2f", stats_data$avg_visible_satellites),
    stats_data$max_visible_satellites,
    stats_data$min_visible_satellites,
    sprintf("%.2f", stats_data$coverage_percentage),
    sprintf("%.2f", stats_data$avg_elevation),
    sprintf("%.2f", stats_data$max_elevation)
  )
)

kable(stats_df, caption = "核心統計指標", col.names = c("指標", "數值"))
```

## 3. 視覺化分析

### 3.1 可見衛星數量時間序列

此圖表展示了在分析時段內，台北地區上空可見的 Starlink 衛星數量隨時間的變化情況。

```{r sat_timeline, fig.cap="可見衛星數量時間序列圖"}
message(paste("RMD sat_timeline: Current working directory:", getwd()))
message(paste("RMD sat_timeline: Using plot path:", sat_plot_path_for_rmd))
message(paste("RMD sat_timeline: Does this plot path exist (relative to RMD)?", file.exists(sat_plot_path_for_rmd)))
# Forcing a check against absolute path as well, just for extreme sanity check
abs_check_sat_plot <- normalizePath(file.path(getwd(), sat_plot_path_for_rmd), mustWork = FALSE)
message(paste("RMD sat_timeline: Absolute check for plot path:", abs_check_sat_plot, "Exists?", file.exists(abs_check_sat_plot)))

if (file.exists(sat_plot_path_for_rmd)) {
  knitr::include_graphics(sat_plot_path_for_rmd)
} else {
  # Fallback if the relative path somehow doesn't work, try the original absolute again
  if(file.exists(abs_sat_plot_path)) {
    message(paste("RMD sat_timeline: Relative path failed, trying original absolute path:", abs_sat_plot_path))
    knitr::include_graphics(abs_sat_plot_path)
  } else {
    cat("衛星數量時間序列圖檔案未找到。預期相對路徑: ", sat_plot_path_for_rmd, "或絕對路徑: ", abs_sat_plot_path)
  }
}
```

### 3.2 最大衛星仰角時間序列

此圖表顯示了在分析時段內，可見衛星中最大仰角隨時間的變化。較高的仰角通常意味著更好的訊號品質。

```{r elev_timeline, fig.cap="最大衛星仰角時間序列圖"}
message(paste("RMD elev_timeline: Current working directory:", getwd()))
message(paste("RMD elev_timeline: Using plot path:", elev_plot_path_for_rmd))
message(paste("RMD elev_timeline: Does this plot path exist (relative to RMD)?", file.exists(elev_plot_path_for_rmd)))
abs_check_elev_plot <- normalizePath(file.path(getwd(), elev_plot_path_for_rmd), mustWork = FALSE)
message(paste("RMD elev_timeline: Absolute check for plot path:", abs_check_elev_plot, "Exists?", file.exists(abs_check_elev_plot)))

if (file.exists(elev_plot_path_for_rmd)) {
  knitr::include_graphics(elev_plot_path_for_rmd)
} else {
   if(file.exists(abs_elev_plot_path)) {
    message(paste("RMD elev_timeline: Relative path failed, trying original absolute path:", abs_elev_plot_path))
    knitr::include_graphics(abs_elev_plot_path)
  } else {
    cat("最大仰角時間序列圖檔案未找到。預期相對路徑: ", elev_plot_path_for_rmd, "或絕對路徑: ", abs_elev_plot_path)
  }
}
```

### 3.3 衛星覆蓋熱力圖

下方為一個互動式熱力圖，展示了在不同時間點（小時和分鐘）的可見衛星數量。顏色越深表示可見衛星越多。

```{r heatmap_interactive}
message(paste("RMD heatmap: Current working directory:", getwd()))
message(paste("RMD heatmap: Using heatmap path:", heatmap_path_for_rmd)) # This is absolute
message(paste("RMD heatmap: Does heatmap_path_for_rmd (absolute) exist?", file.exists(heatmap_path_for_rmd)))
if (file.exists(heatmap_path_for_rmd)) {
  htmltools::includeHTML(heatmap_path_for_rmd)
} else {
  cat("覆蓋熱力圖檔案未找到。預期路徑: ", heatmap_path_for_rmd)
}
```

## 4. 原始數據樣本

下表展示了部分原始覆蓋數據，包含時間戳、可見衛星數量以及最大仰角等信息。您可以進行排序和篩選。

```{r data_table}
# 為了避免過大的 HTML 檔案，只顯示部分數據或進行抽樣
sample_coverage_data <- coverage_data %>%
  select(timestamp, visible_count, elevation, best_satellite, distance_km) %>%
  rename(
    時間戳 = timestamp,
    可見衛星數 = visible_count,
    最大仰角 = elevation,
    最佳衛星 = best_satellite,
    距離公里 = distance_km
  ) %>%
  head(100) # 只顯示前 100 筆數據

DT::datatable(
  sample_coverage_data, 
  options = list(pageLength = 10, scrollX = TRUE, autoWidth = TRUE),
  caption = "覆蓋數據樣本 (前 100 筆)",
  filter = 'top',
  class = 'cell-border stripe hover'
)
```

## 5. 分析說明與限制

- 本分析基於公開的 TLE 數據，其準確性可能隨時間推移而降低。
- 地形遮擋、天氣因素等未在此基礎分析中考慮。
- 「最佳衛星」指在該時間點具有最大仰角的衛星。

---
報告生成時間: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')` 