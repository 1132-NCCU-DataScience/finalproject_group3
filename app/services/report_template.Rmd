---
title: "Starlink 台北地區覆蓋分析報告 (R 版本)"
output:
  html_document:
    toc: true
    toc_float: true
    theme: spacelab
    highlight: tango
    df_print: paged
params:
  # data_dir: "app/static"  # 注解掉原有的預設值
  data_dir: NULL # 設定為 NULL，確保依賴 render 函數傳入的值
  stats_file: "coverage_stats.json"
  coverage_file: "coverage_data.csv"
  sat_timeline_plot: "visible_satellites_timeline.png"
  elev_timeline_plot: "elevation_timeline.png"
  heatmap_plot: "coverage_heatmap.html"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

message(paste("RMD Setup: Initial getwd():", getwd())) # Should be app/services/ when rmarkdown::render runs
message(paste("RMD Setup: Initial params$data_dir (absolute path from R script):", params$data_dir))

# params$data_dir is the absolute path to app/static/
# e.g., /home/lean/Starlink-Taipei/app/static
data_dir_path <- normalizePath(params$data_dir, mustWork = TRUE) # It must exist
message(paste("RMD Setup: Verified absolute data_dir_path:", data_dir_path))

# 載入必要的套件
library(jsonlite)
library(knitr)
library(DT)
library(tidyverse)
library(lubridate)
library(htmltools)

# 原始檔案的絕對路徑
abs_stats_path <- file.path(data_dir_path, params$stats_file)
abs_coverage_path <- file.path(data_dir_path, params$coverage_file)
abs_sat_plot_path <- file.path(data_dir_path, params$sat_timeline_plot)
abs_elev_plot_path <- file.path(data_dir_path, params$elev_timeline_plot)
abs_heatmap_path <- file.path(data_dir_path, params$heatmap_plot)

message(paste("RMD Setup: Absolute sat_plot_path:", abs_sat_plot_path))
message(paste("RMD Setup: Does abs_sat_plot_path exist?", file.exists(abs_sat_plot_path)))

# 簡化的路徑處理 - 直接使用檔案名稱，因為所有檔案都在 app/static 目錄中

# 直接使用 app/static 中的圖片，這樣在 HTML 報告中可以正確顯示
# 因為 Flask 會將 app/static 作為靜態檔案服務
sat_plot_path_for_rmd <- params$sat_timeline_plot  # 例如 "visible_satellites_timeline.png"
elev_plot_path_for_rmd <- params$elev_timeline_plot  # 例如 "elevation_timeline.png"

# HTML 文件通常可以直接使用絕對路徑，或者如果它是自包含的，也可能需要相對路徑
# htmltools::includeHTML 應該能處理絕對路徑，所以 heatmap_path 保持為絕對路徑
heatmap_path_for_rmd <- abs_heatmap_path 
message(paste("RMD Setup: Path for heatmap (includeHTML):", heatmap_path_for_rmd))
message(paste("RMD Setup: Does heatmap_path_for_rmd exist?", file.exists(heatmap_path_for_rmd)))

# 統計和覆蓋數據文件路徑 (這些由 read_json 和 read_csv 讀取，它們應該能處理絕對路徑)
stats_path <- abs_stats_path
coverage_path <- abs_coverage_path

# 檢查檔案是否存在 (用於 json/csv 讀取)
if (!file.exists(stats_path)) {
  stop(paste("統計檔案不存在 (abs path):", stats_path))
}
if (!file.exists(coverage_path)) {
  stop(paste("覆蓋資料檔案不存在 (abs path):", coverage_path))
}

# 讀取統計數據
stats_data <- read_json(stats_path, simplifyVector = TRUE)

# 讀取覆蓋資料 (取樣前 100 筆用於表格顯示)
coverage_data <- read_csv(coverage_path, show_col_types = FALSE) 
```

## 1. 分析概述

本報告詳細說明了 Starlink 衛星在台北地區的覆蓋情況。分析基於最新的 TLE (Two-Line Element) 數據，模擬特定時間段內的可見衛星數量、最大仰角等關鍵指標。

- **觀測地點:** 台北 (`r sprintf("%.2f", stats_data$observer_location$lat)`°N, `r sprintf("%.2f", stats_data$observer_location$lon)`°E)
- **分析時長:** `r stats_data$analysis_duration_minutes` 分鐘
- **數據更新時間:** `r stats_data$last_updated_time`

## 2. 核心統計指標

以下表格總結了本次分析的主要統計結果：

```{r stats_table}
stats_df <- data.frame(
  指標 = c("平均可見衛星數", "最大可見衛星數", "最小可見衛星數", 
           "整體覆蓋率 (%)", "平均最大仰角 (°)", "最高衛星仰角 (°)"),
  數值 = c(
    sprintf("%.2f", stats_data$avg_visible_satellites),
    stats_data$max_visible_satellites,
    stats_data$min_visible_satellites,
    sprintf("%.2f", stats_data$coverage_percentage),
    sprintf("%.2f", stats_data$avg_elevation),
    sprintf("%.2f", stats_data$max_elevation)
  )
)

kable(stats_df, caption = "核心統計指標", col.names = c("指標", "數值"))
```

## 3. 視覺化分析

### 3.1 可見衛星數量時間序列

此圖表展示了在分析時段內，台北地區上空可見的 Starlink 衛星數量隨時間的變化情況。

```{r sat_timeline, fig.cap="可見衛星數量時間序列圖", results='asis'}
# 在 HTML 報告中，我們需要使用相對於靜態檔案服務的路徑
# 因為報告會被放在 app/static/ 目錄下，圖片也在同一目錄
if (file.exists(abs_sat_plot_path)) {
  # 在 HTML 中直接嵌入圖片，使用相對路徑
  cat(paste0('<img src="', sat_plot_path_for_rmd, '" alt="可見衛星數量時間序列圖" style="max-width: 100%; height: auto;" />'))
} else {
  cat("衛星數量時間序列圖檔案未找到。")
}
```

### 3.2 最大衛星仰角時間序列

此圖表顯示了在分析時段內，可見衛星中最大仰角隨時間的變化。較高的仰角通常意味著更好的訊號品質。

```{r elev_timeline, fig.cap="最大衛星仰角時間序列圖", results='asis'}
# 在 HTML 報告中使用相對路徑
if (file.exists(abs_elev_plot_path)) {
  # 在 HTML 中直接嵌入圖片，使用相對路徑
  cat(paste0('<img src="', elev_plot_path_for_rmd, '" alt="最大衛星仰角時間序列圖" style="max-width: 100%; height: auto;" />'))
} else {
  cat("最大仰角時間序列圖檔案未找到。")
}
```

### 3.3 覆蓋品質詳細統計表

下表提供了更詳細的衛星覆蓋品質統計數據，幫助您評估連接的穩定性。

```{r coverage_quality_stats}
# 確保 coverage_data 已完整載入 (不只是樣本)
full_coverage_data <- read_csv(abs_coverage_path, show_col_types = FALSE)

# 總分析時長 (分鐘)
total_duration_minutes <- nrow(full_coverage_data) # 假設每行為一分鐘的數據

# 定義覆蓋閾值
good_coverage_threshold <- 4
no_coverage_threshold <- 0

# 計算良好覆蓋時間和百分比
good_coverage_minutes <- sum(full_coverage_data$visible_count >= good_coverage_threshold)
good_coverage_percentage <- (good_coverage_minutes / total_duration_minutes) * 100

# 計算訊號中斷時間和百分比
no_coverage_minutes <- sum(full_coverage_data$visible_count == no_coverage_threshold)
no_coverage_percentage <- (no_coverage_minutes / total_duration_minutes) * 100

# 計算最長連續良好覆蓋時間
rle_good_coverage <- rle(full_coverage_data$visible_count >= good_coverage_threshold)
max_continuous_good_coverage <- if (any(rle_good_coverage$values)) max(rle_good_coverage$lengths[rle_good_coverage$values], na.rm = TRUE) else 0

# 計算最長連續訊號中斷時間
rle_no_coverage <- rle(full_coverage_data$visible_count == no_coverage_threshold)
max_continuous_no_coverage <- if (any(rle_no_coverage$values)) max(rle_no_coverage$lengths[rle_no_coverage$values], na.rm = TRUE) else 0

# 可見衛星數量分佈
sat_counts_distribution <- full_coverage_data %>%
  mutate(
    category = case_when(
      visible_count == 0 ~ "0 顆 (無訊號)",
      visible_count >= 1 & visible_count <= 3 ~ "1-3 顆 (訊號弱)",
      visible_count == 4 ~ "4 顆 (基本穩定)",
      visible_count >= 5 & visible_count <= 7 ~ "5-7 顆 (良好)",
      visible_count >= 8 ~ "8+ 顆 (極佳)"
    )
  ) %>%
  count(category) %>%
  mutate(
    percentage = (n / total_duration_minutes) * 100,
    category = factor(category, levels = c("0 顆 (無訊號)", "1-3 顆 (訊號弱)", "4 顆 (基本穩定)", "5-7 顆 (良好)", "8+ 顆 (極佳)"))
  ) %>%
  arrange(category)

# 創建統計數據框
quality_stats_df <- data.frame(
  指標 = c(
    "總分析時長 (分鐘)",
    paste0("良好覆蓋時間 (≥", good_coverage_threshold, "顆衛星, 分鐘)"),
    paste0("良好覆蓋時間百分比 (≥", good_coverage_threshold, "顆衛星, %)"),
    "訊號中斷時間 (0顆衛星, 分鐘)",
    "訊號中斷時間百分比 (0顆衛星, %)",
    "最長連續良好覆蓋 (分鐘)",
    "最長連續訊號中斷 (分鐘)"
  ),
  數值 = c(
    total_duration_minutes,
    good_coverage_minutes,
    sprintf("%.2f", good_coverage_percentage),
    no_coverage_minutes,
    sprintf("%.2f", no_coverage_percentage),
    max_continuous_good_coverage,
    max_continuous_no_coverage
  )
)

# 添加衛星數量分佈到表格
distribution_df <- data.frame(
  指標 = paste0("時間佔比 (", sat_counts_distribution$category, ")"),
  數值 = sprintf("%.2f%%", sat_counts_distribution$percentage)
)

combined_stats_df <- rbind(quality_stats_df, distribution_df)

kable(combined_stats_df, caption = "覆蓋品質詳細統計", col.names = c("統計項目", "數值"), align = "l")
```

## 4. 原始數據樣本

下表展示了部分原始覆蓋數據，包含時間戳、可見衛星數量以及最大仰角等信息。您可以進行排序和篩選。

```{r data_table}
# 為了避免過大的 HTML 檔案，只顯示部分數據或進行抽樣
sample_coverage_data <- coverage_data %>%
  select(timestamp, visible_count, elevation, best_satellite, distance_km) %>%
  rename(
    時間戳 = timestamp,
    可見衛星數 = visible_count,
    最大仰角 = elevation,
    最佳衛星 = best_satellite,
    距離公里 = distance_km
  ) %>%
  head(100) # 只顯示前 100 筆數據

DT::datatable(
  sample_coverage_data, 
  options = list(pageLength = 10, scrollX = TRUE, autoWidth = TRUE),
  caption = "覆蓋數據樣本 (前 100 筆)",
  filter = 'top',
  class = 'cell-border stripe hover'
)
```

## 5. 分析說明與限制

- 本分析基於公開的 TLE 數據，其準確性可能隨時間推移而降低。
- 地形遮擋、天氣因素等未在此基礎分析中考慮。
- 「最佳衛星」指在該時間點具有最大仰角的衛星。

---
報告生成時間: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')` 